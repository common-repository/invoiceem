/*! Primary plugin JavaScript. * @since 1.0.0 * @package InvoiceEM */
var accounting=accounting||{},ajaxurl=ajaxurl||"",pagenow=pagenow||"",postboxes=postboxes||{},wp=window.wp||{},iem_script_options=iem_script_options||{},iem_script_validation=iem_script_validation||{};!function(k){"use strict";k(document).ready(function(){k.fn.extend({iem_add_event:function(e,i){return this.addClass(e).on(e,i).iem_trigger_all(e)},iem_equalize_height:function(){var i=0;return this.css("min-height","").each(function(){var e=k(this).height();i=i<e?e:i}).css("min-height",i+"px")},iem_trigger_all:function(e,i){return i="undefined"===k.type(i)?[]:i,k.isArray(i)||(i=[i]),this.each(function(){k(this).triggerHandler(e,i)})},iem_unprepared:function(e){var i="iem-prepared";return e&&(i+="-"+e),this.not("."+i).addClass(i)}}),k.invoiceem=k.invoiceem||{};var c=k.invoiceem;k.extend(c,{admin_bar:k("#wpadminbar"),body:k(document.body),document:k(document),window:k(window),options:iem_script_options||{},validation:iem_script_validation||{},iframe_trigger:null,scroll_top:0,scroll_element:k("html,body").on("DOMMouseScroll mousedown mousewheel scroll touchmove wheel",function(){k(this).stop()})});var s=c.options||{},a=c.validation||{};c.data=c.data||{};var x=c.data;k.extend(x,{ajax_action:"iem-ajax-action",cancel:"iem-cancel",clear:"iem-clear",compare:"iem-compare",conditional:"iem-conditional",field:"iem-field",format:"iem-format",href:"iem-href",identifier:"iem-identifier",index:"iem-index",initial_value:"iem-initial-value",item_count:"iem-item-count",media:"iem-media",media_button:"iem-media-button",media_title:"iem-media-title",max:"iem-max",min:"iem-min",name:"iem-name",number_format:"iem-number-format",object_id:"iem-object-id",placeholder:"iem-placeholder",src:"iem-src",starting_index:"iem-starting-index",step:"iem-step",table:"iem-table",tax:"iem-tax",tooltip:"iem-tooltip",trigger:"iem-trigger",value:"iem-value"}),c.events=c.events||{};var y=c.events;k.extend(y,{calculate:"iem-calculate",change:"iem-change",close:"iem-close",finalize:"iem-finalize",rebuild:"iem-rebuild",sort:"iem-sort"}),c.functions=c.functions||{};var w=c.functions;k.extend(w,{escape_html:function(e){var i={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e.replace(/[&<>"']/g,function(e){return i[e]})},finalize_iframe:function(e){if(null!=c.iframe_trigger){k("#iem-iframe").triggerHandler(y.close);var i=c.iframe_trigger.closest(".iem-field-input").children("select"),t=new Option(e.label,e.id,!0,!0);i.is("[multiple]")||i.empty(),k(t).appendTo(i),k(e.notices).hide().insertBefore(".iem-form").slideDown("fast"),c.document.triggerHandler("wp-updates-notice-added"),i.trigger("change"),c.iframe_trigger=null}},format_currency:function(e,i){if("undefined"===k.type(i)&&(i=accounting.settings),null==i.grouping)return accounting.formatMoney(e,i);var t=accounting.formatNumber(Math.abs(accounting.unformat(e)),i.number).split(i.currency.decimal),a=i.currency.grouping.split(",").reverse(),n=0,r="";do{if(""!=r&&(r=i.currency.thousand+r),t[0].length>a[n]){var o=t[0].length-a[n];r=t[0].substring(o)+r,t[0]=t[0].substring(0,o)}else r=t[0]+r,t[0]="";n=n<a.length-1?n+1:0}while(""!=t[0]);t[0]=r;var s=i.currency.format.zero;return 0<e?s=i.currency.format.pos:e<0&&(s=i.currency.format.neg),s.replace("%s",i.currency.symbol).replace("%v",t.join(i.currency.decimal))},format_number:function(e){if(!k.isNumeric(e))return e;var i=1e-9;return(e*=1)<0&&(i*=-1),1*accounting.formatNumber(e+i,accounting.settings.raw)},load_accounting:function(){var e=k(".iem-currency"),i=e.iem_unprepared(),t=0;e.not(i).iem_trigger_all("focus").each(function(){var e=k(this);e.val(e.val().replace(accounting.settings.currency.decimal,s.accounting.currency.decimal))}),accounting.settings=s.accounting,accounting.settings.invoice_prefix&&k(".iem-invoice-number").each(function(){var e=k(this);e.attr("placeholder",e.data(x.placeholder).replace("{p}",accounting.settings.invoice_prefix)).iem_trigger_all(y.change)}),e.is(".iem-exclude-placeholder")||(accounting.settings.rate&&k.isNumeric(accounting.settings.rate)?t=accounting.settings.rate:e.is("[data-"+x.placeholder+"]")&&(t=e.data(x.placeholder)),t=w.format_currency(t.toString().replace(".",accounting.settings.currency.decimal)),e.attr("placeholder",t).filter(":hidden").val(t)),e.iem_trigger_all("blur"),k(".iem-discount-field .iem-discount-amount").text(accounting.settings.currency.symbol);var a=k("#iem-override_taxes");accounting.settings.taxes&&0<a.length&&!a.is(":checked")&&k(".iem-taxes-repeatable .iem-repeatable").triggerHandler(y.rebuild,[accounting.settings.taxes]),k(".iem-line-items").triggerHandler(y.calculate)},list_form:function(e,i,t){var a=e.closest("tr");if(!a.hasClass("iem-list-form-trigger")){a.addClass("iem-list-form-trigger").siblings(".iem-list-form").find(".iem-cancel").iem_trigger_all("click"),k(".iem-notice.is-dismissible .notice-dismiss").iem_trigger_all("click");var n=a.find(".check-column").length,r=k("<td/>").attr("colspan",a.children(":visible").length-n).append(i);i.find(".iem-cancel").click(function(){var e=k(this).closest("td").children();e.last().addClass("iem-last"),e.slideUp("fast",function(){var e=k(this);if(e.find(".iem-datepicker").datepicker("destroy"),e.find(".iem-spinner").spinner("destroy"),e.find(".iem-tooltip").tooltip("destroy"),e.hasClass("iem-last")){var i=e.closest("tr"),t=i.prev();t.prev().removeClass("iem-list-form-trigger"),t.remove(),i.remove()}})});var o=k("<tr/>").addClass("iem-list-form"),s=i.children().hide();0<n&&o.append(k("<td/>").addClass("check-column")),o.append(r).insertAfter(a),k("<tr/>").addClass("iem-hidden iem-list-form").insertAfter(a),d.currency(s),d.datepicker(s),d.spinner(s),d.tooltip(s),s.slideDown("fast"),"function"===k.type(t)&&t()}},load_iframe:function(e){c.scroll_top=c.window.scrollTop(),c.scroll_element.scrollTop(0).css("overflow","hidden");var i=k(wp.template("iem-iframe-wrapper")()).on(y.close,function(){k(this).fadeOut("fast",function(){c.scroll_element.css("overflow",""),c.window.scrollTop(c.scroll_top),k(this).remove()})});k("<iframe/>").attr("src",e).appendTo(i).on("load ready",function(){var e=k(this),i=e.parent(),t=e.get(0),a=window.parent.jQuery("#iem-iframe").find("#iem-iframe-loading").fadeOut("fast");i.find("#iem-iframe-loading").fadeOut("fast"),k(t.contentWindow).on("beforeunload",function(){a.fadeIn("fast")}),k(t.contentDocument).find("a[href]").not("[target]").not(".iem-same-iframe").click(function(e){e.preventDefault()})}),i.find("#iem-iframe-close").click(function(){var e=k(this).siblings("iframe").get(0),i=0==k(e.contentDocument).find(".iem-iframe-close").length||!e.contentWindow.jQuery.invoiceem.forms.changes_made;(i=i||confirm(s.strings.save_alert))||k("#iem-iframe-loading").fadeOut("fast"),i&&k("#iem-iframe").triggerHandler(y.close)}),i.appendTo(c.body).fadeIn("fast")},pad_number:function(e,i){for(var t=e.toString();t.length<i;)t="0"+t;return t},unformat_currency:function(e){if(k.isNumeric(e))return 1*e;var i=1;return 0===(e=""==e?"0":accounting.unformat(e.replace(accounting.settings.currency.symbol,"")).toString()).indexOf("-")&&(e=e.substring(1),i=-1),w.format_number(e.replace(accounting.settings.currency.decimal,"."))*i}}),c.global=c.global||{};var e=c.global;k.extend(e,{modify_url:function(){s.new_url&&""!=s.new_url&&k.isFunction(window.history.replaceState)&&window.history.replaceState(null,null,s.new_url)},postboxes:function(){"undefined"===k.type(postboxes)||k.isEmptyObject(postboxes)||"undefined"===k.type(pagenow)||(k(".if-js-closed").removeClass("if-js-closed").not(".iem-meta-box-locked").addClass("closed"),postboxes.add_postbox_toggles(pagenow),k(".iem-meta-box-locked").each(function(){var e=k(this);e.find(".handlediv").remove(),e.find(".hndle").off("click.postboxes");var i=k("#"+e.attr("id")+"-hide");i.is(":checked")||i.click(),i.parent().remove()}))}}),e.modify_url(),e.postboxes(),c.setup=c.setup||{};var d=c.setup;k.extend(d,{currency:function(){k(".iem-currency").not("[readonly]").focus(function(){var e=k(this),i=e.val();""!=i&&e.val(accounting.formatNumber(i.replace(accounting.settings.currency.symbol,"")))}).blur(function(){var e=k(this),i=e.val();""!=i&&e.val(w.format_currency(i.replace(accounting.settings.currency.symbol,"")))})},datepicker:function(e){("undefined"===k.type(e)?k(".iem-datepicker").not(".iem-input-template"):e.find(".iem-datepicker")).each(function(){var e=k(this);e.datepicker({dateFormat:e.is("[data-"+x.format+"]")?e.data(x.format):s.date_format})})},dialog:function(){var e={};e[s.strings.cancel]=function(){k(this).dialog("close")},e[s.strings.confirm]=function(){var e=k(this),i=e.data(x.trigger);e.dialog("widget").find("button").prop("disabled",!0),i.is("[data-"+x.href+"]")?window.location=i.data(x.href):i.trigger("click",[!0])},k(".iem-dialog").dialog({autoOpen:!1,buttons:e,closeText:s.strings.close,draggable:!1,modal:!0,resizable:!1,width:280,close:function(){k(this).dialog("widget").find("button").prop("disabled",!1)}})},iframes:function(){k(".iem-iframe-button").click(function(e){e.preventDefault();var i=k(this),t=i.closest(".iem-field-input").children("select"),a=!1,n=i.is("a")?i.attr("href"):i.data(x.src);if(0<t.length){var r=i.is(".iem-edit-button")?t.val():0;k.isNumeric(r)&&(k(".iem-notice.is-dismissible .notice-dismiss").iem_trigger_all("click"),0!=r&&(n=n.replace("__id__",r)),i.is(".iem-ignore-filters")||k("select[data-"+x.ajax_action+"]").not(t).each(function(){var e=k(this),i=e.val();i&&(n+="&"+e.attr("name")+"="+i)}),a=!0)}else a=!0;a&&(c.iframe_trigger=i,w.load_iframe(n))})},select2:function(e){("undefined"===k.type(e)?k("select[data-"+x.ajax_action+"]").not(".iem-input-template"):e.find("select[data-"+x.ajax_action+"]")).each(function(){var i=k(this),a=i.data(x.ajax_action);i.select2({containerCssClass:"iem-select2-selection",delay:200,dropdownCssClass:"iem-select2-dropdown",ajax:{cache:!0,dataType:"json",method:"POST",url:ajaxurl,data:function(e){var t={action:a,not_in:[],page:e.page||1,search:e.term};return k("select[data-"+x.ajax_action+"]").not(".iem-input-template").not(i).each(function(){var e=k(this),i=e.val();e.data(x.ajax_action)==a?t.not_in.push(i):t[e.attr("name")]=i}),t}}}),i.is(".iem-tooltip")&&(i.next().addClass("iem-tooltip").attr("data-"+x.tooltip,i.data(x.tooltip)),d.tooltip(i.parent()))}).on("change.select2",function(){var e=k(this);e.parent().find(".iem-edit-button").prop("disabled",!k.isNumeric(e.val()))}).on("focus",function(){k(this).select2("open")}).on("select2:opening",function(e){var i=k(this);!0===i.data(x.clear)&&(i.removeData(x.clear),e.preventDefault())}).on("select2:select",function(){k(this).valid()}).on("select2:unselecting",function(){k(this).data(x.clear,!0)})},spinner:function(e){("undefined"===k.type(e)?k(".iem-spinner").not(".iem-input-template"):e.find(".iem-spinner")).each(function(){var e=k(this),i=e.attr("name"),t={};a[i]?(k.isNumeric(a[i].max)&&(t.max=a[i].max),k.isNumeric(a[i].min)&&(t.min=a[i].min)):(e.is("[data-"+x.max+"]")&&(t.max=e.data(x.max)),e.is("[data-"+x.min+"]")&&(t.min=e.data(x.min))),e.is("[data-"+x.number_format+"]")&&(t.numberFormat=e.data(x.number_format)),e.is("[data-"+x.step+"]")&&(t.step=e.data(x.step)),e.spinner(t).off("mousewheel"),e.siblings("a").on("mouseleave mouseup",function(){k(this).siblings("input").change()})}).on("change",function(){var e=k(this),i=e.val();isNaN(i)&&e.val("")}).on("keyup spin",function(){k(this).change()})},tooltip:function(e){var i="undefined"===k.type(e)?k(".iem-tooltip").not(".iem-input-template"):e.find(".iem-tooltip"),t=c.body.hasClass("rtl")?"right":"left";i.tooltip({hide:!1,items:"[data-"+x.tooltip+"]",content:function(){return k(this).data(x.tooltip)},position:{at:t+" top",collision:"flipfit",my:t+" bottom-1"}})}});var i=!1;if(c.body.hasClass("iem-iframe"))if(k.isPlainObject(s.iframe)&&k.isNumeric(s.iframe.id))i=!0,window.parent.jQuery.invoiceem.functions.finalize_iframe(s.iframe);else{c.iframes=c.iframes||{};var t=c.iframes;k.extend(t,{buttons:function(){k(".iem-iframe-close").click(function(){f.changes_made&&!confirm(s.strings.save_alert)||window.parent.jQuery("#iem-iframe").triggerHandler(y.close)})}}),t.buttons()}if(!i){if(s.has_list){c.list=c.list||{};var n=c.list;k.extend(n,{actions:function(){k(".iem-single-click").click(function(e){var i=k(this);i.hasClass("iem-clicked")?e.preventDefault():i.addClass("iem-clicked")})},dialogs:function(){k("#doaction,#doaction2").click(function(e,i){var t=k(this),a=t.prev("select").val(),n=k("#iem-confirm-delete-selected"),r=k("#iem-confirm-edit-selected"),o=!0!==i;"iem-bulk-delete"==a&&0<n.length&&o?(e.preventDefault(),n.data(x.trigger,t).dialog("open")):"iem-bulk-deactivate"==a&&0<r.length&&o&&(e.preventDefault(),r.data(x.trigger,t).dialog("open"))}),k("#iem-delete-all").click(function(e,i){!0!==i&&(e.preventDefault(),k("#iem-confirm-delete-all").data(x.trigger,k(this)).dialog("open"))}),k(".iem-confirm-delete").click(function(){var e=k(this),i=k("#iem-confirm-delete").data(x.trigger,e);i.find(".iem-item-name").text(e.closest("td").find("> strong > a").text()),i.dialog("open")}),k(".iem-confirm-edit").click(function(){var e=k(this),i=k("#iem-confirm-edit").data(x.trigger,e);i.find(".iem-item-name").text(e.closest("td").find("> strong > a").text()),i.find(".iem-client-name").text(e.closest("tr").find("> .client_project > strong").text()),i.dialog("open")}),k(".iem-confirm-payment-completed").click(function(){var e=k(this),i=e.closest("tr"),t=k("#iem-confirm-payment-completed").data(x.trigger,e);t.find(".iem-payment-number").text(i.find("> .title > strong > a").text()),t.find(".iem-client-name").text(i.find("> .client_name").text()),t.dialog("open")}),k(".iem-confirm-payment-failed").click(function(){var e=k(this),i=e.closest("tr"),t=k("#iem-confirm-payment-failed").data(x.trigger,e);t.find(".iem-payment-number").text(i.find("> .title > strong > a").text()),t.find(".iem-client-name").text(i.find("> .client_name").text()),t.dialog("open")}),k(".iem-confirm-send,.iem-confirm-resend").click(function(){var e=k(this),i=e.closest("tr"),t=e.is(".iem-confirm-send")?"send":"resend",a=k("#iem-confirm-"+t).data(x.trigger,e);a.find(".iem-item-name").text(i.find("> .title > strong > a").text()),a.find(".iem-client-name").text(i.find("> .client_project > strong").text()),a.dialog("open")})},hide_toggles:function(){k("#adv-settings,.hide-column-tog").click(function(){var e=k(".wp-list-table"),i=e.find("tr.iem-list-form-trigger");0<i.length&&e.find("tr.iem-list-form td[colspan]").attr("colspan",i.children(":visible").length-1)})},notes:function(){k(".iem-add-note").click(function(){var e=k(wp.template("iem-add-note")());e.find(".iem-add-note").click(function(){var e=k(this).closest(".iem-group"),i=e.find("textarea"),t=e.find('input[type="checkbox"]');if(i.valid()){var a=i.add(e.find("button")).prop("disabled",!0),n=e.closest(".iem-notes-form").addClass("iem-loading"),r=pagenow.split("_"),o={action:"iem_add_note",note:i.val(),object_id:n.closest("tr").prev().prev().find(".iem-add-note").data(x.object_id),table:r[r.length-1]};0<t.length&&t.is(":checked")&&(o.send_to_client=!0),k.post({data:o,url:ajaxurl,error:function(){alert(s.strings.unexpected_error),a.prop("disabled",!1),n.removeClass("iem-loading")},success:function(e){k(e).hide().insertBefore(".iem-form").slideDown("fast"),c.document.triggerHandler("wp-updates-notice-added"),n.find(".iem-cancel").triggerHandler("click")}})}}),w.list_form(k(this),e)})}}),d.dialog(),d.iframes(),d.select2(),d.tooltip(),n.actions(),n.dialogs(),n.hide_toggles(),n.notes()}else if(s.has_form){c.fields=c.fields||{};var m=c.fields;k.extend(m,{accounting:function(e){("undefined"===k.type(e)?k(".iem-accounting").not(".iem-input-template"):e.find(".iem-accounting")).on("change.select2",function(){var i=k(this).select2("close"),e=i.attr("name").split("["),t={action:"iem_accounting"};1<e.length?(t.page=e[0],t[e[1].replace("]","")]=i.val()):t[e[0]]=i.val(),i.prop("disabled",!0).add(".iem-currency").closest(".iem-field").addClass("iem-loading"),k.post({data:t,url:ajaxurl,error:function(){alert(s.strings.unexpected_error),i.prop("disabled",!1).add(".iem-currency").closest(".iem-field").removeClass("iem-loading")},success:function(e){s.accounting=e,w.load_accounting(),i.prop("disabled",!1).add(".iem-currency").closest(".iem-field").removeClass("iem-loading")}})})},calculate:function(e){("undefined"===k.type(e)?k(".iem-calculate").not(".iem-input-template"):e.find(".iem-calculate")).on("change",function(){var e=k(this).closest(".iem-repeatable-item"),i=0==e.length?k():e.closest(".iem-field-repeatable");0==i.length||i.is(".iem-taxes-repeatable")?k(".iem-line-items").triggerHandler(y.calculate):i.closest(".iem-line-items").triggerHandler(y.calculate,[e])})},conditional:function(){k(".iem-condition[data-"+x.conditional+"][data-"+x.field+"][data-"+x.value+"][data-"+x.compare+"]").each(function(){var e=k(this),i=k('[name="'+e.data(x.conditional)+'"],[data-'+x.name+'="'+e.data(x.conditional)+'"]'),t=k('[name="'+e.data(x.field)+'"]');!i.hasClass("iem-check-conditions")&&0<t.length&&i.iem_add_event("iem-check-conditions",function(){var e=k(this),r=!0,i=e.is("[name]")?e.attr("name"):e.data(x.name);k(".iem-condition[data-"+x.conditional+'="'+i+'"][data-'+x.field+"][data-"+x.value+"][data-"+x.compare+"]").each(function(){var e=k(this),i=k('[name="'+e.data(x.field)+'"]'),t=e.data(x.compare),a=!1,n=i.is(":radio")?i.filter(":checked").val():i.val();i.is(":checkbox")&&(n=i.is(":checked")?n:""),a="!="===t?e.data(x.value)+""!=n+"":e.data(x.value)+""==n+"",r=r&&a});var t=e.closest(".iem-field");t.next(".iem-field-spacer").remove(),r?t.stop(!0).slideDown("fast"):t.stop(!0).slideUp("fast").after(k("<div/>").addClass("iem-hidden iem-field-spacer"))}),t.hasClass("iem-has-condition")||t.addClass("iem-has-condition").on("change",function(){k(".iem-condition[data-"+x.conditional+"][data-"+x.field+'="'+k(this).attr("name")+'"][data-'+x.value+"][data-"+x.compare+"]").each(function(){k('[name="'+k(this).data(x.conditional)+'"],[data-'+x.name+'="'+e.data(x.conditional)+'"]').iem_trigger_all("iem-check-conditions")})})})},display_history:function(){k(".iem-display-history[data-"+x.table+"]").click(function(){var e=k(this).prop("disabled",!0),i=k("input.iem-object-id");if(0<i.length){var t=e.closest(".iem-field").addClass("iem-loading");k.post({url:ajaxurl,data:{action:"iem_history",column:i.attr("name"),object_id:i.val(),table:e.data(x.table)},error:function(){alert(s.strings.unexpected_error),e.prop("disabled",!1),t.removeClass("iem-loading")},success:function(e){e?(k(e).hide().insertBefore(t).slideDown("fast"),t.slideUp("fast",function(){k(this).remove()})):t.removeClass("iem-loading")}})}})},images:function(){if("function"===k.type(wp.media)){var e=k(".iem-field-image");e.find(".iem-add-button").data(x.media,!1).click(function(){var a=k(this),e=a.closest(".iem-field-image"),n=e.data(x.media);if(!n){var i={multiple:!1,type:"image"};a.is("[data-"+x.media_button+"]")&&(i.button={text:a.data(x.media_button)}),a.is("[data-"+x.media_title+"]")&&(i.title=a.data(x.media_title)),(n=wp.media(i)).on("open",function(){var e=a.closest(".iem-field-image").find("input").val();if(k.isNumeric(e)){var i=wp.media.attachment(e);i.fetch(),i&&n.state().get("selection").add([i])}}).on("select",function(){var e=n.state().get("selection").first().toJSON(),i=e.sizes&&e.sizes.medium?e.sizes.medium.url:e.url,t=a.closest(".iem-field-image");t.find(".iem-image-preview").empty().append(k("<img/>").attr("src",i)),t.find(".iem-remove-button").prop("disabled",!1),t.find("input").val(e.id).change()}),e.data(x.media,n)}n.open()}),e.find(".iem-remove-button").click(function(){var e=k(this).prop("disabled",!0).closest(".iem-field-image");e.find(".iem-image-preview").empty();var i=e.data(x.media),t=e.find("input");if(i){var a=t.val();if(k.isNumeric(a)){var n=wp.media.attachment(a);n.fetch(),n&&i.state().get("selection").remove([n])}}t.val("").change()})}},repeatable:function(){k(".iem-repeatable-tools .iem-add-button").click(function(e,i,t,a){t=k.isNumeric(t)?t:"fast";var n=k(this).closest(".iem-repeatable"),r=n.closest(".iem-field-repeatable"),o=n.data(x.item_count)+1,s=n.find(".iem-repeatable-template");n.data(x.item_count,o);var l=s.clone(!0).attr("data-"+x.starting_index,o-1).removeClass("iem-repeatable-template").hide();l.find(".iem-input-template").removeClass("iem-input-template"),l.find("[data-"+x.identifier+"]").each(function(){var e=k(this),i=e.data(x.identifier).replace("[__i__]","["+(o-1)+"]");e.is("label")?e.attr("for",i):e.attr({id:"iem-"+i,name:i})}),!1===i||"undefined"===k.type(i)?l.insertBefore(s.prev()):l.insertBefore(i),o%2==0?r.next(".iem-field-spacer").remove():k("<div/>").addClass("iem-hidden iem-field-spacer").insertAfter(r),d.datepicker(l),d.select2(l),d.spinner(l),d.tooltip(l),m.accounting(l),m.calculate(l),k.isPlainObject(a)?(k.each(a,function(e,i){var t=l.find('[name$="['+e+']"]');t.is(":checkbox")?t.prop("checked",i):t.val(i)}),n.triggerHandler(y.sort,[!1])):n.triggerHandler(y.sort),l.slideDown(t),0!=t&&(f.changes_made=!0)});var e=k(wp.template("iem-repeatable-buttons")()).click(function(e){k(this).closest(".iem-repeatable").is(":animated")?e.stopImmediatePropagation():f.changes_made=!0});e.filter(".iem-repeatable-move-up").click(function(){var e=k(this).parent(),i=e.prev(".iem-repeatable-item");0<i.length&&e.insertBefore(i).parent().triggerHandler(y.sort)}),e.filter(".iem-repeatable-move-down").click(function(){var e=k(this).parent(),i=e.next(".iem-repeatable-item").not(".iem-repeatable-template");0<i.length&&e.insertAfter(i).parent().triggerHandler(y.sort)}),e.filter(".iem-repeatable-insert").click(function(){var e=k(this).parent();e.parent().find(".iem-add-button").triggerHandler("click",[e])}),e.filter(".iem-repeatable-remove").click(function(){var e=k(this).parent(),i=e.parent();e.slideUp("fast",function(){e.find(".iem-datepicker").datepicker("destroy"),e.find(".iem-spinner").spinner("destroy"),e.find(".iem-tooltip").tooltip("destroy"),e.remove(),i.triggerHandler(y.sort)})}),k(".iem-repeatable-item").each(function(){e.clone(!0).appendTo(k(this))}),k(".iem-repeatable").each(function(){var e=k(this);e.data(x.item_count,e.find(".iem-repeatable-item").not(".iem-repeatable-template").length)}).on(y.rebuild,function(e,i){if(i){var t=k(this).data(x.item_count,0);t.find(".iem-repeatable-item").not(".iem-repeatable-template").remove();var a=t.find(".iem-add-button");k.each(i,function(e,i){a.triggerHandler("click",[!1,0,i])}),t.triggerHandler(y.finalize)}}).on(y.sort,function(e,i){var t=k(this),a=t.closest(".iem-field-repeatable"),n=t.children(".iem-repeatable-item").not(".iem-repeatable-template");a.is(".iem-repeatable-locked")?t.addClass("ui-sortable-disabled"):(t.hasClass("ui-sortable")||t.mousedown(function(){var e=k(this);e.height(e.height())}).mouseup(function(){k(this).css("height","")}).sortable({containment:"parent",cursor:"move",forcePlaceholderSize:!0,handle:"> .iem-repeatable-move",items:"> .iem-repeatable-item",opacity:.75,placeholder:"iem-repeatable-placeholder",revert:"fast",tolerance:"pointer",stop:function(e,i){f.changes_made=!0,i.item.parent(".iem-repeatable").triggerHandler(y.sort)}}),1<n.length?t.sortable("enable"):t.sortable("disable")),n.each(function(e){var i=k(this);i.find(".iem-order-index").val(e),i.find(".iem-repeatable-count").text(e+1)}),!1!==i&&t.triggerHandler(y.finalize)}).iem_trigger_all(y.sort)}}),c.forms=c.forms||{};var f=c.forms;k.extend(f,{changes_made:!1,before_unload:function(){c.window.on("beforeunload",function(){if(f.changes_made)return s.strings.save_alert})},fields:function(){k(".iem-form").find("input,select,textarea").not(".iem-ignore-change").each(function(){var e=k(this);e.data(x.initial_value,e.val())}).change(function(){var e=k(this);e.val()!=e.data(x.initial_value)&&(f.changes_made=!0)}),d.currency(),d.datepicker(),d.spinner(),d.tooltip(),m.accounting(),m.calculate(),m.conditional(),m.display_history(),m.images(),m.repeatable(),w.load_accounting()},notes:function(){k(".iem-notes-form button").click(function(){var e=k(this),i=e.text(),t=e.closest(".iem-group").children(".iem-hidden").stop(!0,!0);e.text(e.data(x.cancel)).data(x.cancel,i),t.is(":visible")?t.slideUp("fast").find("textarea").prop("disabled",!0):t.slideDown("fast").find("textarea").prop("disabled",!1)})},tabs:function(){k(".iem-tabs .iem-secondary-tab-wrapper a").each(function(e){k(this).data(x.index,e).click(function(){var e=k(this);if(!e.hasClass("iem-tab-active")){var i=e.closest(".iem-tabs").find(".iem-tab-content > div").eq(e.data(x.index));0<i.length&&e.add(i).addClass("iem-tab-active").siblings().removeClass("iem-tab-active")}})})},validation:function(){k.validator.addMethod("iem-unique",function(e,i,t){var a=k(i),n=0;return a.closest("form").find(t).not(a).each(function(){k(this).val()==e&&n++}),this.optional(i)||0==n},k.validator.format(s.strings.unique_message)),k(".iem-form").each(function(){k(this).validate({focusInvalid:!1,rules:a,errorPlacement:function(e,i){var t=i.next(".select2");0==t.length&&(t=i.parent(".ui-spinner")),0==t.length&&(t=i),e.hide().insertAfter(t).slideDown("fast")},highlight:function(e,i){var t=k(e).addClass(i).next(".select2");0<t.length&&t.addClass(i)},invalidHandler:function(e,i){if(i.numberOfInvalids()){var t=k(i.errorList[0].element),a=t.closest(".iem-tab");if(0<a.length&&!a.hasClass(".iem-tab-active")){var n=a.parent().children(".iem-tab").index(a);a.closest(".iem-tabs").find(".iem-tab-buttons a").eq(n).triggerHandler("click")}var r=c.admin_bar.height(),o=c.window.height()-r,s=t.outerHeight(),l=t.offset().top-r;s<o&&(l-=Math.floor((o-s-r)/2)),c.scroll_element.animate({scrollTop:Math.max(0,Math.min(c.document.height()-o,l))+"px"},{queue:!1})}},showErrors:function(){k(".iem-notice.is-dismissible .notice-dismiss").iem_trigger_all("click");var e=k(".iem-notice.iem-validation-error");0<this.numberOfInvalids()&&!e.hasClass("iem-invalid")?e.stop(!0).addClass("iem-invalid").slideDown("fast"):0==this.numberOfInvalids()&&e.hasClass("iem-invalid")&&e.stop(!0).removeClass("iem-invalid").slideUp("fast"),this.defaultShowErrors()},submitHandler:function(e){var i=k(e);i.find('[type="submit"]').prop("disabled",!0),i.find(".iem-currency").iem_trigger_all("focus"),i.find(".iem-discount-field").each(function(){var e=k(this);if(e.find(".iem-discount-percentage").hasClass("button-primary")){var i=e.find("input");""!=i.val()&&i.val(i.val()+"%")}}),f.changes_made=!1,e.submit()},unhighlight:function(e,i){var t=k(e).removeClass(i).next(".select2");0<t.length&&t.removeClass(i)}})}).find('[type="submit"]').click(function(){var e=k(this).addClass("iem-clicked");e.closest("form").find('[type="submit"]').not(e).removeClass("iem-clicked")}).prop("disabled",!1)}}),d.dialog(),d.iframes(),d.select2(),f.before_unload(),f.fields(),f.notes(),f.tabs(),f.validation()}if(s.is_currency){c.currency=c.currency||{};var r=c.currency;k.extend(r,{samples:function(){k(".iem-form input").change(function(e){var i=e.keyCode||e.which;9!=i&&16!=i&&k(this).triggerHandler(y.change)}).on(y.change,function(){var e=k("#iem-symbol").val(),i=k("#iem-decimal_separator").val(),t=k("#iem-thousand_separator").val(),a=k("#iem-decimal_digits").val(),n=k("#iem-positive_format").val(),r=k("#iem-negative_format").val(),o=k("#iem-zero_format").val(),s="",l="",c="";if(""!=e&&""!=i&&i!=t&&""!=a&&""!=n&&""!=r){var d={symbol:e,decimal:i,thousand:t,precision:a,format:{pos:n,neg:r,zero:""==o?n:o}};s=w.format_currency(1234567890.9876542,d),l=w.format_currency(-1234567890.9876542,d),c=w.format_currency(0,d)}else s=w.format_currency(1234567890.9876542),l=w.format_currency(-1234567890.9876542),c=w.format_currency(0);k("#iem-currency-sample").html(w.escape_html(s)+"<br />"+w.escape_html(l)+"<br />"+w.escape_html(c))}).first().triggerHandler(y.change)}}),r.samples()}else if(s.is_extensions){c.extensions=c.extensions||{};var o=c.extensions;k.extend(o,{boxes:function(){c.window.resize(function(){k("#iem-extensions .iem-field-group").each(function(){var e=k(this);e.find(".iem-extension-top").iem_equalize_height(),e.find(".iem-extension-bottom").iem_equalize_height()})}).triggerHandler("resize")},license_keys:function(){k(".iem-license-key").on("keypress",function(e){13==(e.keyCode||e.which)&&(e.preventDefault(),k(this).siblings("button:visible").triggerHandler("click"))}),k(".iem-license-key-button").click(function(){var t=k(this),a=t.siblings("input"),n=t.closest(".iem-field");if(a.is(":disabled")||a.valid()){var r=t.add(a).prop("disabled",!0),o=t.hasClass("iem-deactivate-button");n.addClass("iem-loading"),k(".iem-notice.is-dismissible .notice-dismiss").iem_trigger_all("click"),k.post({url:ajaxurl,data:{action:s.action,"iem-extension":a.attr("name"),"iem-license-key":a.val(),"iem-edd-action":o?"deactivate_license":"activate_license"},error:function(){alert(s.strings.unexpected_error),r.prop("disabled",!1),n.removeClass("iem-loading")},success:function(e){if(e.notice&&k(e.notice).hide().insertBefore(".iem-form").slideDown("fast"),c.document.triggerHandler("wp-updates-notice-added"),e.success){t.siblings("button").prop("disabled",!1);var i=t.closest("p");o?(i.removeClass("iem-activated"),a.prop("disabled",!1)):i.addClass("iem-activated")}else o?t.prop("disabled",!1):r.prop("disabled",!1);n.removeClass("iem-loading")}})}})}}),o.boxes(),o.license_keys()}else if(s.is_invoice){c.invoice=c.invoice||{};var l=c.invoice;k.extend(l,{calculations:function(){var e=k(".iem-line-items").on(y.calculate,function(e,i){var t=k(this),n=t.find(".iem-repeatable-item").not(".iem-repeatable-template"),a=0,r=!1,o=!1,s=0,l=0,c=0;"undefined"===k.type(i)?n.iem_trigger_all(y.calculate):!1!==i&&i.triggerHandler(y.calculate),n.each(function(){var e=k(this);a+=1*e.find(".iem-totals input.iem-subtotal").val(),r||(r=0<k(this).find(".iem-taxes :checkbox:checked").length)&&(o=!0)});var d=k("#iem-pre_tax_discount").stop(!0),m=t.find(".iem-pre-tax-discount-row");if(r){var f=d.val();k.isNumeric(f)&&0!=f?(s=d.closest(".iem-discount-field").find(".iem-discount-amount").hasClass("button-primary")?-1*f:w.format_number(a*(f/100)*-1),n.each(function(){var e=k(this),i=1*e.find(".iem-totals input.iem-subtotal").val();e.find(".iem-totals input.iem-discounted-subtotal").val(w.format_number(i+i/a*s))}),m.show()):m.hide(),d.closest(".iem-field").slideDown(!0);var u=t.find(".iem-tax-row.iem-hidden");u.nextAll(".iem-tax-row").remove();var p=u;k(".iem-taxes-repeatable .iem-repeatable-item").not(".iem-repeatable-template").each(function(){var e=k(this),i=e.find('[name$="[r]"]').val();if(k.isNumeric(i)){i/=100;var t=0;if(n.find(".iem-taxes .iem-field[data-"+x.starting_index+'="'+e.data(x.starting_index)+'"] :checkbox:checked').each(function(){t+=i*k(this).closest(".iem-repeatable-item").find(".iem-totals input.iem-discounted-subtotal").val()}),0<(t=w.format_number(t))){var a=u.clone().removeClass("iem-hidden").insertAfter(p);a.find(".iem-tax-label").text(e.find('[name$="[l]"]').val()),a.find(".iem-tax-output").text(w.format_currency(t)),l+=t,p=a}}})}else d.closest(".iem-field").slideUp(!0),m.hide(),t.find(".iem-tax-row").nextAll(".iem-tax-row").remove();var g=k("#iem-discount"),h=g.val(),v=t.find(".iem-discount-row");k.isNumeric(h)&&0!=h?(o=!0,c=g.closest(".iem-discount-field").find(".iem-discount-amount").hasClass("button-primary")?-1*h:(a+s+l)*(h/100)*-1,c=w.format_number(c),v.show()):v.hide();var b=t.find(".iem-subtotal-row"),_=-1*k("#iem-paid").val();_<0&&(o=!0,t.find(".iem-paid-row").show().find(".iem-paid-output").text(w.format_currency(_))),b.find(".iem-subtotal-output").text(w.format_currency(a)),t.find(".iem-pre-tax-discount-output").text(w.format_currency(s)),t.find(".iem-discount-output").text(w.format_currency(c)),t.find(".iem-total-output").text(w.format_currency(a+s+l+c+_)),o?b.show():b.hide()});e.find(".iem-repeatable").on(y.finalize,function(){k(this).closest(".iem-line-items").triggerHandler(y.calculate)}).find(".iem-repeatable-item").on(y.calculate,function(){var e=k(this),i=w.unformat_currency(e.find(".iem-rate").val()),t=e.find(".iem-taxes :checkbox:checked");if(0<t.length){var a=k(".iem-taxes-repeatable .iem-repeatable-item").not(".iem-repeatable-template"),n=0;t.each(function(){var e=k(this).closest(".iem-field"),i=a.filter("[data-"+x.starting_index+'="'+e.data(x.starting_index)+'"]');if(0<i.length&&i.find('[name$="[i]"]').is(":checked")){var t=i.find('[name$="[r]"]').val();k.isNumeric(t)&&(n+=1*t/100)}}),0<n&&(i=w.format_number(i/(1+n)))}var r=e.find(".iem-quantity"),o=r.val();k.isNumeric(o)||(r.val(""),o=0);var s=w.format_number(i*o),l=e.find(".iem-adjustment"),c=l.val();k.isNumeric(c)||(l.val(""),c=0),s+=c=w.format_number(s*(c/100));var d=e.find(".iem-totals");d.find("input").val(s),d.find(".iem-line-item-subtotal").text(w.format_currency(s))}),e.triggerHandler(y.calculate)},discount_fields:function(){k(".iem-discount-field").find("button").click(function(){k(this).addClass("button-primary").siblings("button").removeClass("button-primary"),k(".iem-line-items").triggerHandler(y.calculate,[!1]),f.changes_made=!0})},sort_button:function(){k(".iem-sort-button").click(function(){var e=k(this).closest(".iem-repeatable"),i=e.children(".iem-repeatable-item").not(".iem-repeatable-template"),t=k("<div/>").insertBefore(i.first()),a=k();i.each(function(){var e=k(this);e.find(".iem-datepicker").val()&&(a=a.add(e))}),a.sort(function(e,i){var t=0,a=k(e).find(".iem-datepicker").datepicker("getDate"),n=k(i).find(".iem-datepicker").datepicker("getDate");if(a&&n){var r=a.getTime(),o=n.getTime();r<o?t=-1:o<r&&(t=1)}return t}).insertAfter(t),e.triggerHandler(y.sort),t.remove(),f.changes_made=!0})},taxes:function(){k("#iem-override_taxes").change(function(){var e=k(this);e.is(":checked")||e.closest(".inside").find(".iem-repeatable").triggerHandler(y.rebuild,[accounting.settings.taxes])}),k(".iem-taxes-repeatable .iem-repeatable").on(y.finalize,function(){var i=k(this).find(".iem-repeatable-item").not(".iem-repeatable-template"),e=k(".iem-line-items");if(0==i.length)e.find(".iem-taxes").addClass("iem-hidden").find(".iem-group .iem-field").remove();else{e.find(".iem-repeatable-item").each(function(){var e=k(this),s=e.is(".iem-repeatable-template"),l=null,c=s?"":e.data(x.starting_index),d=e.find(".iem-taxes").removeClass("iem-hidden").find(".iem-group");d.children(".iem-field").addClass("iem-remove"),i.each(function(e){var i=k(this),t=i.data(x.starting_index),a=d.children("[data-"+x.starting_index+'="'+t+'"]'),n=i.find('[name$="[l]"]').val();if(""==n&&(n="--"),0==a.length){var r='<div class="iem-field iem-field-checkbox" data-iem-starting-index="_si_"><div class="iem-field-input"><label class="iem-description"><input id="iem-line_items[_li_][taxes][]" name="line_items[_li_][taxes][]" type="checkbox" value="1" class="iem-calculate" data-iem-identifier="line_items[__i__][taxes][]" /><span>_la_</span></label></div></div>'.replace(/_si_/g,t).replace(/_la_/g,n);s||(r=r.replace(/_li_/g,c));var o=(a=k(r)).find(":checkbox");s?o.removeAttr("id name").addClass("iem-input-template").prop("checked",!0):o.change(function(){var e=k(this);e.closest(".iem-line-items").triggerHandler(y.calculate,[e.closest(".iem-repeatable-item")])})}else a.removeClass("iem-remove").find("span").text(n);a.find(":checkbox").val(e),null==l?a.prependTo(d):a.insertAfter(l),l=a}),d.children(".iem-remove").remove()})}k(".iem-line-items").triggerHandler(y.calculate),k(this).find('[name$="[l]"]').iem_unprepared().change(function(){k(this).closest(".iem-repeatable").triggerHandler(y.finalize)})})}}),l.calculations(),l.discount_fields(),l.sort_button(),l.taxes()}else if(s.is_payment){c.payment=c.payment||{};var u=c.payment;k.extend(u,{calculations:function(){k(".iem-line-items").on(y.calculate,function(){var e=0,i=w.unformat_currency(k("#iem-bonus").val()),t=0!=i,a=w.unformat_currency(k("#iem-fee").val()),n=0!=a,r=k(".iem-subtotal-row"),o=k(".iem-bonus-row"),s=k(".iem-fee-row");k(this).find(".iem-calculate").each(function(){e+=w.unformat_currency(k(this).val())}),t||n?(r.show(),k(".iem-subtotal-output").text(w.format_currency(e)),t?(o.show(),k(".iem-bonus-output").text(w.format_currency(i))):o.hide(),n?(s.show(),k(".iem-fee-output").text(w.format_currency(a))):s.hide()):r.add(o).add(s).hide(),k(".iem-total-output").text(w.format_currency(e+i+a))}).iem_trigger_all(y.calculate)}}),u.calculations()}else if(s.is_view){d.iframes(),c.view=c.view||{};var p=c.view;k.extend(p,{scale:function(){c.window.resize(function(){var e=c.body.width(),i=k(".iem-sheet"),t="";e<958&&(t=Math.max(260,e)/918+"em"),i.css("font-size",t)}).triggerHandler("resize")}}),p.scale()}}})}(jQuery);